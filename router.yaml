# The runtime container comes with sensible defaults that work well for most use cases.
# Uncomment the COPY and CMD lines in the Dockerfile to use this configuration.

sandbox:
  enabled: false
supergraph:
  introspection: true
  listen: 0.0.0.0:${env.PORT:-4000}
  path: /graphql
  query_planning:
    cache:
      in_memory:
        limit: 512 # This is the default value
homepage:
  enabled: false
include_subgraph_errors:
  all: true

cors:
  policies:
    - origins:
        # Apollo Studio
        - https://studio.apollographql.com
        
        # Local .local domains (HTTPS)
        - https://ticketfi.local
        - https://auth.ticketfi.local
        - https://dashboard.ticketfi.local
        - https://organizer.ticketfi.local
        - https://manager.ticketfi.local
        - https://promoter.ticketfi.local
        - https://venue.ticketfi.local
        - https://talent.ticketfi.local
        - https://attendee.ticketfi.local
        - https://api.ticketfi.local
        
        # Development domains (.dev)
        - https://ticketfi.dev
        - https://auth.ticketfi.dev
        - https://dashboard.ticketfi.dev
        - https://organizer.ticketfi.dev
        - https://manager.ticketfi.dev
        - https://promoter.ticketfi.dev
        - https://venue.ticketfi.dev
        - https://talent.ticketfi.dev
        - https://attendee.ticketfi.dev
        - https://api.ticketfi.dev
        
        # Staging domains (.net)
        - https://ticketfi.net
        - https://auth.ticketfi.net
        - https://dashboard.ticketfi.net
        - https://organizer.ticketfi.net
        - https://manager.ticketfi.net
        - https://promoter.ticketfi.net
        - https://venue.ticketfi.net
        - https://talent.ticketfi.net
        - https://attendee.ticketfi.net
        - https://api.ticketfi.net
        
        # Production domains (.ai)
        - https://ticketfi.ai
        - https://auth.ticketfi.ai
        - https://dashboard.ticketfi.ai
        - https://organizer.ticketfi.ai
        - https://manager.ticketfi.ai
        - https://promoter.ticketfi.ai
        - https://venue.ticketfi.ai
        - https://talent.ticketfi.ai
        - https://attendee.ticketfi.ai
        - https://api.ticketfi.ai
      allow_credentials: true
      allow_headers:
        - content-type
        - authorization
        - apollo-require-preflight
        - x-request-id
        - cookie
      expose_headers:
        - apollo-require-preflight
        - content-type
        - set-cookie
        - content-length
        - content-encoding
        - date
        - server
        - x-apollo-tracing
        - apollographql-client-name
        - apollographql-client-version
        - x-response-time
        - x-request-id

# Header forwarding - CRITICAL for auth to work
headers:
  all:
    request:
      - propagate:
          named: "authorization"
      - propagate:
          named: "cookie"

limits:
  parser_max_tokens: 15000 # This is the default value.
  parser_max_recursion: 4096 # This is the default value.
  max_depth: 100 # Must be 15 or larger to support standard introspection query
  max_height: 200
  max_aliases: 30
  max_root_fields: 20

# Health check
health_check:
  enabled: true
  listen: 0.0.0.0:${env.PORT:-4000}
  path: /health

# Traffic shaping for subgraph health and reliability
traffic_shaping:
  all:
    timeout: 30s
    deduplicate_query: true
  subgraphs:
    products:
      timeout: 5s
      deduplicate_query: true
    users:
      timeout: 5s
      deduplicate_query: true

# Telemetry
telemetry:
  apollo:
    endpoint: https://usage-reporting.api.apollographql.com/api/ingress/traces
  exporters:
    metrics:
      prometheus:
        enabled: true
        listen: 0.0.0.0:${env.PORT:-4000}
        path: /metrics
  instrumentation:
    spans:
      mode: spec_compliant
